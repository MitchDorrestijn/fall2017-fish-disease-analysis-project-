<html>
        <head>
            <title>Authentication - Proof of Concept<</title>
            <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
            <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
            <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
            <script>
                // Initialize Firebase
                var config = {
                    apiKey: "AIzaSyBxbF0vZXeq8ItH9SsQvO8Ynev_5-lGffs",
                    authDomain: "fishproject-47cfd.firebaseapp.com",
                    databaseURL: "https://fishproject-47cfd.firebaseio.com",
                    projectId: "fishproject-47cfd",
                    storageBucket: "fishproject-47cfd.appspot.com",
                    messagingSenderId: "324776878982"
                };
                firebase.initializeApp(config);
                const Auth = firebase.auth();
                const messaging = firebase.messaging();
            </script>
        </head>
        <body>
            <input type="text" name="email" placeholder="Emailadres" id="email" />
            <input type="password" name="password" placeholder="Wachtwoord" id="password" />
            <button type="submit" id="knop">Log in!</button>
            <span id="message"></span>
            <script>
                let idToken = "";
                $('#knop').click(function(e){
                    const email = $('#email').val();
                    const password = $('#password').val();
                    firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
                        // Handle Errors here.
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        // ...
                        $('#message').html("Error...");
                    }).then(function(result){
                        console.log(result);
                        if(result){
                            $('#message').html("Gelukt! Userid: " + result.uid);
                            Auth.currentUser.getIdToken().then(function(data) {
                                console.log(data)
                                idToken = data;
                            });

                            messaging.requestPermission()
                            .then(function() {
                                console.log('Notification permission granted.');
                                getToken()
                            })
                            .catch(function(err) {
                                console.log('Unable to get permission to notify.', err);
                            });
                            return;
                        }
                        $('#message').html("Fail...");
                    });
                });

                messaging.onTokenRefresh(() => {
                    getToken();
                });

                messaging.onMessage((payload) => {
                    console.log("Message: " + payload);
                });

                const getToken = () => {
                    // Get token and send to server
                    messaging.getToken()
                    .then(function(currentToken) {
                        if (currentToken) {
                            console.log(currentToken);
                            firebase.firestore()
                            .collection("users")
                            .doc(Auth.currentUser.uid)
                            .collection("devices")
                            .doc(currentToken)
                            .set({
                                device: "Browser",
                                id: currentToken
                            })
                            //db.coll
                        } else {
                            console.log('No Instance ID token available. Request permission to generate one.');
                        }
                    })
                    .catch(function(err) {
                        console.log('An error occurred while retrieving token. ', err);
                    });
                }
            </script>

            <br />
            <br />
            <br />
            <br />
            <input type="file" id="imageInput" />
            <button id="uploadBtn">Upload</button>
            <script>
                $('#uploadBtn').click((e) => {
                    let formData = new FormData();
                    formData.append('testdata', 'toon dit!');
                    formData.append('image', $('#imageInput').prop('files')[0]); 
                    $.ajax({
                        url: 'http://localhost:5000/api/species/mQovDDr3IpGJYtW5w0z2/upload',
                        beforeSend: function(request) {
                            request.setRequestHeader("Authorization", "Token " + idToken);
                        },
                        data: formData,
                        type: 'POST',
                        contentType: false, // NEEDED, DON'T OMIT THIS (requires jQuery 1.6+)
                        processData: false, // NEEDED, DON'T OMIT THIS
                        // ... Other options like success and etc
                    });
                })
            </script>
        </body>
    </html>