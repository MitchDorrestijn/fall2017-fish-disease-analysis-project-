<html>
    <head>
        <title>Authentication - Proof of Concept<</title>
        <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase-firestore.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
        <script>
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyBxbF0vZXeq8ItH9SsQvO8Ynev_5-lGffs",
                authDomain: "fishproject-47cfd.firebaseapp.com",
                databaseURL: "https://fishproject-47cfd.firebaseio.com",
                projectId: "fishproject-47cfd",
                storageBucket: "fishproject-47cfd.appspot.com",
                messagingSenderId: "324776878982"
            };
            firebase.initializeApp(config);
            const db = firebase.firestore();
            const messaging = firebase.messaging();

            messaging.requestPermission()
            .then(function() {
                console.log('Notification permission granted.');
                getToken()
            })
            .catch(function(err) {
                console.log('Unable to get permission to notify.', err);
            });

            messaging.onTokenRefresh(() => {
                getToken();
            });

            messaging.onMessage((payload) => {
                console.log("Message: " + payload);
            });

            const getToken = () => {
                // Get token and send to server
                messaging.getToken()
                .then(function(currentToken) {
                    if (currentToken) {
                        console.log(currentToken);
                        //db.coll
                    } else {
                        console.log('No Instance ID token available. Request permission to generate one.');
                    }
                })
                .catch(function(err) {
                    console.log('An error occurred while retrieving token. ', err);
                });
            }
        </script>
    </head>
    <body>
        <div class="container">
            <div class="row">
                
                    <div class="input-group mb-2 mr-sm-2 mb-sm-0">
                        <input type="text" class="form-control" id="email" placeholder="Email">
                    </div>

                    <div class="input-group mb-2 mr-sm-2 mb-sm-0"></div>
                        <input type="password" class="form-control" id="password" placeholder="Password">
                    </div>

                    <button type="submit" class="btn btn-primary" id="knop">Submit</button>

                <span id="message"></span>
                <script>
                    $('#knop').click(function(e){
                        const email = $('#email').val();
                        const password = $('#password').val();
                        firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
                            // Handle Errors here.
                            var errorCode = error.code;
                            var errorMessage = error.message;
                            // ...
                            $('#message').html("Error...");
                        }).then(function(result){
                            console.log(result);
                            if(result){
                                $('#message').html("Gelukt! Userid: " + result.uid);
                                Auth = firebase.auth();
                                Auth.currentUser.getIdToken().then(function(data) {
                                    console.log(data)
                                });
                                return;
                            }
                            $('#message').html("Fail...");
                        });
                    });
                </script>
        
                <table id="rules-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Species</th>
                            <th>Aquarium Attribute</th>
                            <th>Equation</th>
                            <th>Compared to</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                    </tbody>
                </table>
                <button id="get-rules">Get rules</button>
                <script>
                    $('#get-rules').click((e) => {
                        $.getJSON("/api/notifications/rules", (data) => {
                            console.log(data);
                            data.forEach((row) => {
                                let tr = "<tr>";
                                tr += "<th scope='row'>" + row.id + "</th>";
                                tr += "<td>" + row.species + "</td>";
                                tr += "<td>" + row.attribute + "</td>";
                                tr += "<td>" + row.equation + "</td>";
                                tr += "<td>" + row.compared + "</td>";
                                tr += "<td>" + row.message + "</td>";
                                tr += "</tr>";
                                $('#rules-table > tbody:last-child').append(tr);
                            })
                        });
                    });
                </script>
            </div>
        </div>
    </body>
</html>